# 工作流名称
name: 云端构建并推送 Docker 镜像到 GHCR

# 触发条件：推送到 main 分支、打标签时执行；也可手动触发
on:
  push:
    branches: [ main ]          # 推送到主分支时触发
    tags: [ 'v*' ]              # 打版本标签（如v1.0.0）时触发
  workflow_dispatch:            # 允许手动在 GitHub 页面触发

# 作业定义：在 Ubuntu 最新版虚拟机中运行
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read            # 读取仓库代码
      packages: write           # 推送镜像到 GHCR
      packages: read            # 补充读权限，避免兼容问题

    steps:
      # 步骤1：检出仓库代码（获取 Dockerfile 等文件）
      - name: 检出代码
        uses: actions/checkout@v4

      # 步骤2：设置 Docker Buildx（增强构建能力，支持多平台、缓存）
      - name: 配置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 步骤3：登录 GitHub Container Registry（GHCR）
      - name: 登录 GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}          # 自动填充你的 GitHub 用户名
          password: ${{ secrets.GITHUB_TOKEN }} # GitHub 自动生成的令牌

      # 步骤4：构建并推送 Docker 镜像（核心步骤）
      - name: 构建并推送镜像
        uses: docker/build-push-action@v5
        with:
          context: .                            # 构建上下文：仓库根目录
          file: ./Dockerfile                    # 显式指定 Dockerfile 路径（更严谨）
          push: true                            # 推送到 GHCR
          pull: true                            # 拉取最新基础镜像（避免缓存旧基础镜像）
          # 镜像标签：修复 || 语法错误
          tags: |
            ghcr.io/${{ github.repository_owner }}/plexamp-cast:latest
            ghcr.io/${{ github.repository_owner }}/plexamp-cast:${{ github.ref_name != '' ? github.ref_name : github.sha }}
          # 开启构建缓存（加速下次构建）
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # 可选：多平台构建（取消注释开启，适配amd64/arm64）
          # platforms: linux/amd64,linux/arm64/v8

      # 可选步骤：验证镜像（优化 sed 命令，仅替换目标服务的 image 行）
      - name: 验证镜像（通过 docker-compose）
        if: success()  # 仅前面步骤成功时执行
        run: |
          # 精准替换：只替换服务名为 plexamp-cast 的 image 行（需匹配你的 compose 服务名）
          sed -i '/plexamp-cast/ s|image: .*|image: ghcr.io/${{ github.repository_owner }}/plexamp-cast:latest|g' docker-compose.yml
          # 启动 compose 并验证（仅测试，启动后停止）
          docker-compose up -d
          sleep 10
          docker-compose ps
          docker-compose down
